<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAD Viewer | Municipal Robotics</title>
  <meta name="description" content="Interactive 3D viewer for BVR rover CAD models">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/bold/style.css">
  <style>
    :root {
      --panel-bg: rgba(10, 10, 10, 0.92);
      --panel-border: rgba(255, 255, 255, 0.08);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --panel-bg: rgba(255, 255, 255, 0.95);
        --panel-border: rgba(0, 0, 0, 0.1);
      }
    }

    body {
      background: var(--bg);
      overflow: hidden;
      margin: 0;
    }

    /* Full-screen canvas */
    .viewer-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* Top bar: model selector and back link */
    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      pointer-events: none;
      z-index: 100;
    }

    .top-bar > * {
      pointer-events: auto;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-link {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--fg-muted);
      text-decoration: none;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      padding: 8px 12px;
      transition: color 0.15s, border-color 0.15s;
    }

    .back-link:hover {
      color: var(--orange);
      border-color: var(--orange);
      background: var(--panel-bg);
    }

    /* Model selector dropdown */
    .model-selector {
      position: relative;
    }

    .model-selector-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      padding: 10px 14px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      color: var(--fg);
      min-width: 200px;
      transition: border-color 0.15s;
    }

    .model-selector-btn:hover,
    .model-selector.open .model-selector-btn {
      border-color: var(--orange);
    }

    .model-selector-btn i {
      color: var(--orange);
      font-size: 18px;
    }

    .model-selector-btn .chevron {
      margin-left: auto;
      font-size: 12px;
      color: var(--fg-muted);
      transition: transform 0.2s;
    }

    .model-selector.open .chevron {
      transform: rotate(180deg);
    }

    .model-selector-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      min-width: 280px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 200;
    }

    .model-selector.open .model-selector-menu {
      display: block;
    }

    .model-menu-section {
      padding: 8px 0;
      border-bottom: 1px solid var(--panel-border);
    }

    .model-menu-section:last-child {
      border-bottom: none;
    }

    .model-menu-section-title {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--fg-muted);
      padding: 6px 14px;
    }

    .model-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
      color: var(--fg);
    }

    .model-menu-item:hover {
      background: rgba(255, 102, 0, 0.1);
    }

    .model-menu-item.active {
      background: rgba(255, 102, 0, 0.15);
    }

    .model-menu-item i {
      font-size: 18px;
      color: var(--fg-muted);
      width: 22px;
      text-align: center;
    }

    .model-menu-item.active i,
    .model-menu-item:hover i {
      color: var(--orange);
    }

    .model-menu-item-info {
      flex: 1;
    }

    .model-menu-item-name {
      font-size: 12px;
      font-weight: 500;
    }

    .model-menu-item-desc {
      font-size: 10px;
      color: var(--fg-muted);
      margin-top: 2px;
    }

    /* Component explorer (left panel) */
    .component-explorer {
      position: absolute;
      top: 70px;
      left: 20px;
      bottom: 70px;
      width: 260px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      display: flex;
      flex-direction: column;
      z-index: 50;
      transition: opacity 0.2s, transform 0.2s;
    }

    .component-explorer.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-20px);
    }

    .explorer-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--panel-border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .explorer-title {
      flex: 1;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--orange);
    }

    .explorer-count {
      font-size: 10px;
      color: var(--fg-muted);
    }

    .explorer-close {
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: var(--fg-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s;
      font-size: 14px;
    }

    .explorer-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--fg);
    }

    @media (prefers-color-scheme: light) {
      .explorer-close:hover {
        background: rgba(0, 0, 0, 0.08);
      }
    }

    .explorer-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    .explorer-content::-webkit-scrollbar {
      display: none; /* Chrome/Safari/Opera */
    }

    .explorer-section {
      margin-bottom: 4px;
    }

    .explorer-section-title {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--fg-muted);
      padding: 8px 16px 6px;
    }

    .explorer-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .explorer-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    @media (prefers-color-scheme: light) {
      .explorer-item:hover {
        background: rgba(0, 0, 0, 0.03);
      }
    }

    .explorer-item.active {
      background: rgba(255, 102, 0, 0.12);
    }

    .explorer-item-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255, 102, 0, 0.15);
      border: 2px solid var(--orange);
      color: var(--fg);
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .explorer-item.active .explorer-item-number {
      background: var(--orange);
      color: #000;
    }

    .explorer-item-info {
      flex: 1;
      min-width: 0;
    }

    .explorer-item-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--fg);
    }

    .explorer-item-desc {
      font-size: 10px;
      color: var(--fg-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Inspector panel (right) */
    .inspector {
      position: absolute;
      top: 70px;
      right: 20px;
      width: 280px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      z-index: 50;
      transition: opacity 0.2s, transform 0.2s;
    }

    .inspector.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateX(20px);
    }

    .inspector-header {
      padding: 16px;
      border-bottom: 1px solid var(--panel-border);
    }

    .inspector-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--orange);
      margin-bottom: 4px;
    }

    .inspector-subtitle {
      font-size: 11px;
      color: var(--fg-muted);
      line-height: 1.4;
    }

    .inspector-props {
      padding: 12px 16px;
    }

    .inspector-prop {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 6px 0;
      border-bottom: 1px solid var(--panel-border);
    }

    .inspector-prop:last-child {
      border-bottom: none;
    }

    .inspector-prop-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--fg-muted);
    }

    .inspector-prop-value {
      font-size: 11px;
      color: var(--fg);
      text-align: right;
    }

    .inspector-actions {
      padding: 12px 16px;
      border-top: 1px solid var(--panel-border);
      display: flex;
      gap: 8px;
    }

    .inspector-btn {
      flex: 1;
      background: transparent;
      border: 1px solid var(--panel-border);
      color: var(--fg);
      padding: 8px;
      font-family: inherit;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }

    .inspector-btn:hover {
      border-color: var(--orange);
      background: rgba(255, 102, 0, 0.1);
    }

    /* Bottom controls */
    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 20px;
      pointer-events: none;
      z-index: 100;
    }

    .bottom-bar > * {
      pointer-events: auto;
    }

    .controls-group {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      padding: 6px;
    }

    .control-btn {
      background: transparent;
      border: 1px solid transparent;
      color: var(--fg);
      padding: 8px 14px;
      font-family: inherit;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: border-color 0.15s, background 0.15s, color 0.15s;
    }

    .control-btn:hover {
      border-color: var(--orange);
      background: rgba(255, 102, 0, 0.1);
    }

    .control-btn.active {
      background: rgba(255, 102, 0, 0.2);
      color: var(--orange);
    }

    .control-btn i {
      font-size: 14px;
    }

    .control-divider {
      width: 1px;
      height: 20px;
      background: var(--panel-border);
      margin: 0 4px;
    }

    /* Scale reference dropdown */
    .scale-dropdown {
      position: relative;
    }

    .scale-menu {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      background: var(--panel-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--panel-border);
      min-width: 240px;
      z-index: 200;
    }

    .scale-dropdown.open .scale-menu {
      display: block;
    }

    .scale-menu-header {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--fg-muted);
      padding: 12px 14px 8px;
      border-bottom: 1px solid var(--panel-border);
    }

    .scale-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .scale-menu-item:hover {
      background: rgba(255, 102, 0, 0.1);
    }

    .scale-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--panel-border);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: border-color 0.15s, background 0.15s;
    }

    .scale-checkbox.checked {
      border-color: var(--orange);
      background: var(--orange);
    }

    .scale-checkbox.checked::after {
      content: '✓';
      color: #000;
      font-size: 12px;
      font-weight: bold;
    }

    .scale-menu-item i {
      font-size: 18px;
      color: var(--fg-muted);
    }

    .scale-menu-item-info {
      flex: 1;
    }

    .scale-menu-item-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--fg);
    }

    .scale-menu-item-desc {
      font-size: 10px;
      color: var(--fg-muted);
      margin-top: 2px;
    }

    /* Help text */
    .help-text {
      position: absolute;
      bottom: 16px;
      right: 20px;
      font-size: 9px;
      color: var(--fg-muted);
      text-align: right;
      line-height: 1.6;
      pointer-events: none;
      z-index: 10;
    }

    /* Attributions */
    .attributions {
      position: absolute;
      bottom: 60px;
      right: 20px;
      font-size: 9px;
      color: var(--fg-muted);
      text-align: right;
      z-index: 10;
    }

    .attributions a {
      color: var(--fg-muted);
      text-decoration: none;
      display: block;
      margin-bottom: 2px;
    }

    .attributions a:hover {
      color: var(--orange);
    }

    .attributions .license {
      font-size: 8px;
      opacity: 0.7;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 10, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--orange);
      font-size: 12px;
      letter-spacing: 0.1em;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 500;
    }

    .loading-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* Drop zone overlay */
    .drop-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255, 102, 0, 0.1);
      border: 3px dashed var(--orange);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 400;
    }

    .drop-overlay.visible {
      opacity: 1;
    }

    .drop-overlay-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--orange);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .component-explorer {
        width: 220px;
      }
      .inspector {
        width: 240px;
      }
    }

    @media (max-width: 700px) {
      .component-explorer {
        left: 10px;
        right: 10px;
        width: auto;
        top: auto;
        bottom: 70px;
        max-height: 200px;
      }
      .inspector {
        display: none;
      }
    }
  </style>
</head>
<body>

<div class="viewer-container">
  <canvas id="canvas"></canvas>

  <!-- Top bar -->
  <div class="top-bar">
    <div class="top-left">
      <a href="index.html" class="back-link">
        <i class="ph ph-arrow-left"></i>
        <span>Home</span>
      </a>

      <div class="model-selector" id="modelSelector">
        <button class="model-selector-btn" id="modelSelectorBtn">
          <i class="ph ph-cube"></i>
          <span id="modelSelectorLabel">Select Model</span>
          <i class="ph ph-caret-down chevron"></i>
        </button>
        <div class="model-selector-menu" id="modelSelectorMenu"></div>
      </div>
    </div>
  </div>

  <!-- Component explorer -->
  <div class="component-explorer hidden" id="explorer">
    <div class="explorer-header">
      <span class="explorer-title">Components</span>
      <span class="explorer-count" id="explorerCount"></span>
      <button class="explorer-close" id="explorerClose" title="Hide labels">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="explorer-content" id="explorerContent"></div>
  </div>

  <!-- Inspector panel -->
  <div class="inspector hidden" id="inspector">
    <div class="inspector-header">
      <div class="inspector-title" id="inspectorTitle">Select a component</div>
      <div class="inspector-subtitle" id="inspectorSubtitle"></div>
      </div>
    <div class="inspector-props" id="inspectorProps"></div>
    <div class="inspector-actions">
      <button class="inspector-btn" id="btnFocus">Focus</button>
      <button class="inspector-btn" id="btnIsolate">Isolate</button>
      <button class="inspector-btn" id="btnReset">Reset</button>
      </div>
    </div>

  <!-- Bottom controls -->
  <div class="bottom-bar">
    <div class="controls-group">
      <button class="control-btn" id="btnWireframe">
        <i class="ph ph-polygon"></i>
        Wireframe
      </button>
      <div class="control-divider"></div>
      <div class="scale-dropdown" id="scaleDropdown">
        <button class="control-btn" id="btnScale">
          <i class="ph ph-ruler"></i>
          Scale
        </button>
        <div class="scale-menu" id="scaleMenu">
          <div class="scale-menu-header">Scale References</div>
          <div id="scaleMenuItems"></div>
        </div>
      </div>
      <div class="control-divider"></div>
      <button class="control-btn" id="btnLabels">
        <i class="ph ph-tag"></i>
        Labels
      </button>
      </div>
    </div>

  <!-- Help text -->
  <div class="help-text">
      Grid: 10mm cells, 100mm sections<br>
      Drag to rotate · Scroll to zoom<br>
      Right-drag to pan
    </div>

  <!-- Attributions -->
  <div class="attributions" id="attributions"></div>

  <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">LOADING...</div>

  <!-- Drop zone overlay -->
  <div class="drop-overlay" id="dropOverlay">
    <div class="drop-overlay-text">Drop STL or GLB file</div>
  </div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';

// =============================================================================
// MODEL CATALOG
// =============================================================================

const models = [
  { section: 'Assemblies', items: [
    { id: 'bvr1', name: 'BVR1 Production', path: 'models/bvr1_assembly.glb', icon: 'rocket-launch', desc: 'Current production rover', hasLabels: true },
    { id: 'bvr0', name: 'BVR0 Prototype', path: 'models/bvr0_assembly.glb', icon: 'rocket-launch', desc: 'First prototype rover', hasLabels: false },
  ]},
  { section: 'Frame', items: [
    { id: 'frame', name: 'BVR1 Frame', path: 'models/bvr1_frame.glb', icon: 'blueprint', desc: 'Aluminum extrusion frame', hasLabels: false },
  ]},
  { section: 'Drivetrain', items: [
    { id: 'svb6hs', name: 'SVB6HS 6.5"', path: 'models/uumotor_svb6hs.glb', icon: 'tire', desc: '500W hub motor, 6.5" wheel', hasLabels: false },
    { id: 'kn6104', name: 'KN6104 10"', path: 'models/uumotor_kn6104.glb', icon: 'tire', desc: '800W hub motor, 10" wheel', hasLabels: false },
    { id: 'mount', name: 'Motor Mount', path: 'models/uumotor_mount.glb', icon: 'wrench', desc: 'Adjustable wheel mount', hasLabels: false },
  ]},
  { section: 'Electronics', items: [
    { id: 'tray', name: 'Base Tray', path: 'models/base_tray.glb', icon: 'package', desc: 'Electronics mounting plate', hasLabels: false },
    { id: 'panel', name: 'Access Panel', path: 'models/access_panel.glb', icon: 'door-open', desc: 'Removable service panel', hasLabels: false },
  ]},
];

// BVR1 component hotspots
const bvr1Components = [
  { id: 1, section: 'Sensors', name: 'LiDAR', desc: 'Livox Mid-360, 360° scanning', specs: '40m range, 200k pts/sec', position: { x: 0, y: 520, z: 200 } },
  { id: 2, section: 'Sensors', name: '360° Camera', desc: 'Insta360 X4, panoramic video', specs: '8K 360° capture', position: { x: 0, y: 420, z: 200 } },
  { id: 3, section: 'Sensors', name: 'RTK GPS', desc: 'Multi-band GNSS antenna', specs: 'cm-level positioning', position: { x: 80, y: 470, z: 200 } },
  { id: 4, section: 'Controls', name: 'E-Stop', desc: 'Emergency stop button', specs: 'NC contacts, 22mm', position: { x: -150, y: 340, z: -200 } },
  { id: 5, section: 'Electronics', name: 'Jetson Orin NX', desc: 'Main compute module', specs: '100 TOPS, 16GB RAM', position: { x: 130, y: 170, z: 180 } },
  { id: 6, section: 'Electronics', name: 'DC-DC Converter', desc: '48V to 12V supply', specs: '300W continuous', position: { x: 130, y: 155, z: -180 } },
  { id: 7, section: 'Electronics', name: 'VESC (FL)', desc: 'Front-left motor controller', specs: 'VESC 6, 60A', position: { x: -160, y: 155, z: 120 } },
  { id: 8, section: 'Electronics', name: 'VESC (RL)', desc: 'Rear-left motor controller', specs: 'VESC 6, 60A', position: { x: -160, y: 155, z: -120 } },
  { id: 9, section: 'Power', name: 'Battery Pack', desc: 'Custom 13S4P Li-ion', specs: '48V 14Ah, 672Wh', position: { x: 0, y: 185, z: 0 } },
  { id: 10, section: 'Frame', name: 'Frame', desc: '2020 aluminum extrusion', specs: '380×600mm footprint', position: { x: 0, y: 250, z: 0 } },
  { id: 11, section: 'Frame', name: 'Access Panel', desc: 'Removable top cover', specs: 'ABS, quick-release', position: { x: 100, y: 324, z: 100 } },
  { id: 12, section: 'Frame', name: 'Base Tray', desc: 'Electronics mounting', specs: 'ABS, 6mm thick', position: { x: 100, y: 140, z: -100 } },
  { id: 13, section: 'Drivetrain', name: 'Hub Motor (FL)', desc: 'UUMotor SVB6HS', specs: '500W, 6.5" wheel', position: { x: -132, y: 38, z: 260 } },
  { id: 14, section: 'Drivetrain', name: 'Hub Motor (FR)', desc: 'UUMotor SVB6HS', specs: '500W, 6.5" wheel', position: { x: 132, y: 38, z: 260 } },
  { id: 15, section: 'Drivetrain', name: 'Hub Motor (RL)', desc: 'UUMotor SVB6HS', specs: '500W, 6.5" wheel', position: { x: -132, y: 38, z: -260 } },
  { id: 16, section: 'Drivetrain', name: 'Hub Motor (RR)', desc: 'UUMotor SVB6HS', specs: '500W, 6.5" wheel', position: { x: 132, y: 38, z: -260 } },
  { id: 17, section: 'Drivetrain', name: 'Motor Mount', desc: 'L-bracket mount', specs: '6061-T6 aluminum', position: { x: -190, y: 100, z: 260 } },
];

// Scale references
const scaleReferences = [
  { id: 'banana', name: 'Banana', icon: 'plant', desc: 'Universal scale reference', path: 'models/banana.glb', scale: 1.0, rotateY: Math.PI },
  { id: 'astronaut', name: 'Astronaut', icon: 'person-arms-spread', desc: '1.85m tall', path: 'models/astronaut.glb', scale: 1000.0, attribution: { title: 'astronaut', author: 'Antropik', url: 'https://skfb.ly/oVwuz', license: 'CC BY 4.0' } },
  { id: 'grogu', name: 'Grogu', icon: 'star-four', desc: '34cm tall', path: 'models/grogu.glb', scale: 34.0, attribution: { title: 'BABY YODA FREE 3D', author: 'OSCAR CREATIVO', url: 'https://skfb.ly/6Rovs', license: 'CC BY 4.0' } },
];

// =============================================================================
// THREE.JS SETUP
// =============================================================================

const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.outputColorSpace = THREE.SRGBColorSpace;

const scene = new THREE.Scene();

// Theme detection
const darkTheme = { background: 0x0a0a0a, gridCell: 0x3a3634, gridSection: 0x57534e };
const lightTheme = { background: 0xf5f5f4, gridCell: 0xd6d3d1, gridSection: 0xa8a29e };

function getTheme() {
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? darkTheme : lightTheme;
}

let currentTheme = getTheme();
scene.background = new THREE.Color(currentTheme.background);

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  currentTheme = getTheme();
  scene.background.set(currentTheme.background);
  if (gridMaterial) {
    gridMaterial.uniforms.uColor1.value.set(currentTheme.gridCell);
    gridMaterial.uniforms.uColor2.value.set(currentTheme.gridSection);
  }
});

const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 5000);
camera.position.set(600, 400, 600);

const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;
controls.dampingFactor = 0.05;

// Lighting
scene.add(new THREE.AmbientLight(0xffffff, 0.4));
const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
keyLight.position.set(200, 300, 200);
scene.add(keyLight);
const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
fillLight.position.set(-200, 100, -100);
scene.add(fillLight);
const rimLight = new THREE.DirectionalLight(0xff6600, 0.3);
rimLight.position.set(0, -100, -200);
scene.add(rimLight);

// Grid
const gridMaterial = new THREE.ShaderMaterial({
  uniforms: {
    uCellSize: { value: 10.0 },
    uSectionSize: { value: 100.0 },
    uColor1: { value: new THREE.Color(currentTheme.gridCell) },
    uColor2: { value: new THREE.Color(currentTheme.gridSection) },
    uFadeDistance: { value: 2000.0 },
  },
  vertexShader: `
    varying vec3 vWorldPos;
    void main() {
      vec4 worldPos = modelMatrix * vec4(position, 1.0);
      vWorldPos = worldPos.xyz;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,
  fragmentShader: `
    varying vec3 vWorldPos;
    uniform float uCellSize, uSectionSize, uFadeDistance;
    uniform vec3 uColor1, uColor2;
    void main() {
      float dist = length(vWorldPos.xz);
      float fade = 1.0 - smoothstep(uFadeDistance * 0.3, uFadeDistance, dist);
      vec2 cellFrac = fract(vWorldPos.xz / uCellSize);
      vec2 sectionFrac = fract(vWorldPos.xz / uSectionSize);
      float cellLine = step(cellFrac.x, 0.04) + step(1.0 - cellFrac.x, 0.04) + step(cellFrac.y, 0.04) + step(1.0 - cellFrac.y, 0.04);
      float sectionLine = step(sectionFrac.x, 0.015) + step(1.0 - sectionFrac.x, 0.015) + step(sectionFrac.y, 0.015) + step(1.0 - sectionFrac.y, 0.015);
      vec3 color = uColor1;
      float alpha = min(cellLine, 1.0) * 0.25 * fade;
      if (sectionLine > 0.5) { color = uColor2; alpha = 0.5 * fade; }
      if (alpha < 0.02) discard;
      gl_FragColor = vec4(color, alpha);
    }
  `,
  side: THREE.DoubleSide,
  transparent: true,
  depthWrite: false,
});

const grid = new THREE.Mesh(new THREE.PlaneGeometry(20000, 20000), gridMaterial);
grid.rotation.x = -Math.PI / 2;
grid.frustumCulled = false;
scene.add(grid);

// =============================================================================
// STATE
// =============================================================================

let currentModel = null;
let currentModelInfo = null;
let selectedComponent = null;
let labelsVisible = true;
let isWireframe = false;
let isolatedMesh = null;

const hotspotGroup = new THREE.Group();
scene.add(hotspotGroup);

const scaleRefState = {};
scaleReferences.forEach(ref => {
  scaleRefState[ref.id] = { mesh: null, visible: false };
});

const loaders = {
  gltf: new GLTFLoader(),
  stl: new STLLoader(),
};

// =============================================================================
// UI ELEMENTS
// =============================================================================

const $ = id => document.getElementById(id);
const loading = $('loading');
const explorer = $('explorer');
const explorerContent = $('explorerContent');
const explorerCount = $('explorerCount');
const inspector = $('inspector');
const inspectorTitle = $('inspectorTitle');
const inspectorSubtitle = $('inspectorSubtitle');
const inspectorProps = $('inspectorProps');
const modelSelector = $('modelSelector');
const modelSelectorBtn = $('modelSelectorBtn');
const modelSelectorLabel = $('modelSelectorLabel');
const modelSelectorMenu = $('modelSelectorMenu');

// =============================================================================
// MODEL LOADING
// =============================================================================

function showLoading(show) {
  loading.classList.toggle('visible', show);
}

function loadModel(modelInfo) {
  showLoading(true);

  if (currentModel) {
    scene.remove(currentModel);
    currentModel = null;
  }

  // Clear selection
  selectedComponent = null;
  clearHotspots();

  const url = modelInfo.path + '?t=' + Date.now();

  loaders.gltf.load(url, (gltf) => {
    currentModel = gltf.scene;
    currentModelInfo = modelInfo;

    // Rotate from Z-up to Y-up
    currentModel.rotation.x = -Math.PI / 2;

    // Position on ground
    currentModel.updateMatrixWorld(true);
    const box = new THREE.Box3().setFromObject(currentModel);
    currentModel.position.y = -box.min.y;

    scene.add(currentModel);

    // Frame view
    currentModel.updateMatrixWorld(true);
    const finalBox = new THREE.Box3().setFromObject(currentModel);
    const size = finalBox.getSize(new THREE.Vector3());
    const center = finalBox.getCenter(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    camera.position.set(center.x + maxDim, center.y + maxDim * 0.6, center.z + maxDim);
    controls.target.copy(center);
    controls.update();

    // Update UI
    updateModelSelector(modelInfo);

    // Show labels if model has them
    if (modelInfo.hasLabels && labelsVisible) {
      createHotspots();
      buildExplorer();
      explorer.classList.remove('hidden');
    } else {
      explorer.classList.add('hidden');
    }

    // Update inspector with model info
    showModelInspector(modelInfo, size);

    // Reposition scale refs
    repositionScaleRefs();

    showLoading(false);
  }, undefined, (err) => {
    console.error('Error loading model:', err);
    showLoading(false);
  });
}

function showModelInspector(modelInfo, size) {
  inspector.classList.remove('hidden');
  inspectorTitle.textContent = modelInfo.name;
  inspectorSubtitle.textContent = modelInfo.desc;

  inspectorProps.innerHTML = `
    <div class="inspector-prop">
      <span class="inspector-prop-label">Dimensions</span>
      <span class="inspector-prop-value">${size.x.toFixed(0)} × ${size.y.toFixed(0)} × ${size.z.toFixed(0)} mm</span>
    </div>
  `;
}

function showComponentInspector(component) {
  inspector.classList.remove('hidden');
  inspectorTitle.textContent = component.name;
  inspectorSubtitle.textContent = component.desc;

  let props = `
    <div class="inspector-prop">
      <span class="inspector-prop-label">Specs</span>
      <span class="inspector-prop-value">${component.specs}</span>
    </div>
    <div class="inspector-prop">
      <span class="inspector-prop-label">Section</span>
      <span class="inspector-prop-value">${component.section}</span>
    </div>
  `;

  inspectorProps.innerHTML = props;
}

// =============================================================================
// MODEL SELECTOR
// =============================================================================

function buildModelSelector() {
  let html = '';

  models.forEach(section => {
    html += `<div class="model-menu-section">
      <div class="model-menu-section-title">${section.section}</div>`;

    section.items.forEach(item => {
      html += `
        <div class="model-menu-item" data-id="${item.id}">
          <i class="ph ph-${item.icon}"></i>
          <div class="model-menu-item-info">
            <div class="model-menu-item-name">${item.name}</div>
            <div class="model-menu-item-desc">${item.desc}</div>
          </div>
        </div>`;
    });

    html += '</div>';
  });

  modelSelectorMenu.innerHTML = html;

  // Click handlers
  modelSelectorMenu.querySelectorAll('.model-menu-item').forEach(item => {
    item.onclick = () => {
      const id = item.dataset.id;
      const modelInfo = findModelById(id);
      if (modelInfo) {
        loadModel(modelInfo);
        closeModelSelector();
      }
    };
  });
}

function findModelById(id) {
  for (const section of models) {
    for (const item of section.items) {
      if (item.id === id) return item;
    }
  }
  return null;
}

function updateModelSelector(modelInfo) {
  modelSelectorLabel.textContent = modelInfo.name;

  // Update active state
  modelSelectorMenu.querySelectorAll('.model-menu-item').forEach(item => {
    item.classList.toggle('active', item.dataset.id === modelInfo.id);
  });
}

function closeModelSelector() {
  modelSelector.classList.remove('open');
}

modelSelectorBtn.onclick = (e) => {
  e.stopPropagation();
  modelSelector.classList.toggle('open');
};

document.addEventListener('click', () => {
  closeModelSelector();
  $('scaleDropdown').classList.remove('open');
});

modelSelectorMenu.onclick = (e) => e.stopPropagation();

// =============================================================================
// HOTSPOTS / LABELS
// =============================================================================

function createHotspotSprite(number, isActive = false) {
  // Higher resolution for crisp rendering
  const size = 128;
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  const center = size / 2;
  const radius = size / 2 - 8;

  // Draw circle background
  ctx.beginPath();
  ctx.arc(center, center, radius, 0, Math.PI * 2);

  if (isActive) {
    // Active: solid orange fill with white border (matches sidebar .active)
    ctx.fillStyle = '#ff6600';
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 4;
    ctx.stroke();
  } else {
    // Inactive: black background with orange border (matches sidebar appearance)
    ctx.fillStyle = '#000000';
    ctx.fill();
    ctx.strokeStyle = '#ff6600';
    ctx.lineWidth = 4;
    ctx.stroke();
  }

  // Draw number with Berkeley Mono
  ctx.font = '700 52px "Berkeley Mono", ui-monospace, monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillStyle = isActive ? '#000000' : '#ffffff';
  // Slight vertical adjustment for visual centering
  ctx.fillText(String(number), center, center + 2);

  const texture = new THREE.CanvasTexture(canvas);
  texture.minFilter = THREE.LinearFilter;
  texture.magFilter = THREE.LinearFilter;
  texture.colorSpace = THREE.SRGBColorSpace;
  texture.generateMipmaps = false;
  // sizeAttenuation: true makes sprites smaller with distance
  const material = new THREE.SpriteMaterial({
    map: texture,
    transparent: true,
    depthTest: false,
    sizeAttenuation: true,
    toneMapped: false,
    fog: false,
  });
  const sprite = new THREE.Sprite(material);
  // Larger base scale since attenuation will shrink with distance
  sprite.scale.set(28, 28, 1);
  sprite.renderOrder = 999;
  return sprite;
}

async function createHotspots() {
  clearHotspots();
  if (!currentModel) return;

  // Ensure Berkeley Mono is loaded before drawing to canvas
  await document.fonts.ready;

  currentModel.updateMatrixWorld(true);
  const modelBox = new THREE.Box3().setFromObject(currentModel);
  const modelSize = modelBox.getSize(new THREE.Vector3());
  const labelOffset = Math.max(modelSize.x, modelSize.z) * 0.12 + 50;

  bvr1Components.forEach(comp => {
    const anchor = new THREE.Vector3(comp.position.x, comp.position.y, comp.position.z);

    // Label position
    const dir = new THREE.Vector3(comp.position.x, 0, comp.position.z).normalize();
    if (dir.length() < 0.1) dir.set(1, 0, 0);
    const labelPos = anchor.clone().add(dir.multiplyScalar(labelOffset));
    labelPos.y = anchor.y + 30;

    // Sprite
    const sprite = createHotspotSprite(comp.id, selectedComponent?.id === comp.id);
    sprite.position.copy(labelPos);
    sprite.userData = { componentId: comp.id, anchor };
    hotspotGroup.add(sprite);

    // Line (bright orange for visibility)
    const lineGeo = new THREE.BufferGeometry().setFromPoints([labelPos, anchor]);
    const lineMat = new THREE.LineBasicMaterial({ color: 0xff6600, transparent: true, opacity: 1.0, depthTest: true });
    const line = new THREE.Line(lineGeo, lineMat);
    hotspotGroup.add(line);

    // Anchor dot with ring (depth tested so it can be occluded by model)
    // Outer ring (dark)
    const ringGeo = new THREE.RingGeometry(3, 5, 16);
    const ringMat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide, depthTest: true });
    const ring = new THREE.Mesh(ringGeo, ringMat);
    ring.position.copy(anchor);
    ring.lookAt(camera.position);
    hotspotGroup.add(ring);

    // Inner dot (orange)
    const dotGeo = new THREE.CircleGeometry(3, 16);
    const dotMat = new THREE.MeshBasicMaterial({ color: 0xff6600, side: THREE.DoubleSide, depthTest: true });
    const dot = new THREE.Mesh(dotGeo, dotMat);
    dot.position.copy(anchor);
    dot.lookAt(camera.position);
    hotspotGroup.add(dot);
  });
}

function clearHotspots() {
  while (hotspotGroup.children.length > 0) {
    const child = hotspotGroup.children[0];
    if (child.material) {
      if (child.material.map) child.material.map.dispose();
      child.material.dispose();
    }
    if (child.geometry) child.geometry.dispose();
    hotspotGroup.remove(child);
  }
}

function toggleLabels() {
  labelsVisible = !labelsVisible;
  $('btnLabels').classList.toggle('active', labelsVisible);

  if (labelsVisible && currentModelInfo?.hasLabels) {
    createHotspots();
    buildExplorer();
    explorer.classList.remove('hidden');
  } else {
    clearHotspots();
    explorer.classList.add('hidden');
  }
}

// =============================================================================
// COMPONENT EXPLORER
// =============================================================================

function buildExplorer() {
  const sections = {};
  bvr1Components.forEach(c => {
    if (!sections[c.section]) sections[c.section] = [];
    sections[c.section].push(c);
  });

  let html = '';
  Object.entries(sections).forEach(([name, items]) => {
    html += `<div class="explorer-section">
      <div class="explorer-section-title">${name}</div>`;

    items.forEach(item => {
      const isActive = selectedComponent?.id === item.id;
      html += `
        <div class="explorer-item ${isActive ? 'active' : ''}" data-id="${item.id}">
          <div class="explorer-item-number">${item.id}</div>
          <div class="explorer-item-info">
            <div class="explorer-item-name">${item.name}</div>
            <div class="explorer-item-desc">${item.desc}</div>
          </div>
        </div>`;
    });

    html += '</div>';
  });

  explorerContent.innerHTML = html;
  explorerCount.textContent = `${bvr1Components.length} parts`;

  // Click handlers
  explorerContent.querySelectorAll('.explorer-item').forEach(item => {
    item.onclick = () => selectComponent(parseInt(item.dataset.id));
  });
}

function selectComponent(id) {
  const comp = bvr1Components.find(c => c.id === id);
  if (!comp) return;

  selectedComponent = comp;

  // Update explorer
  explorerContent.querySelectorAll('.explorer-item').forEach(item => {
    item.classList.toggle('active', parseInt(item.dataset.id) === id);
  });

  // Update inspector
  showComponentInspector(comp);

  // Update hotspots
  createHotspots();

  // Animate camera to component
  focusOnPosition(comp.position);
}

function focusOnPosition(pos) {
  const target = new THREE.Vector3(pos.x, pos.y, pos.z);
  const dist = 350;
  const angle = Math.atan2(pos.z, pos.x) + Math.PI / 4;
  const targetCam = new THREE.Vector3(
    target.x + Math.cos(angle) * dist,
    target.y + dist * 0.4,
    target.z + Math.sin(angle) * dist
  );

  animateCamera(targetCam, target, 500);
}

function animateCamera(targetPos, targetLookAt, duration) {
  const startPos = camera.position.clone();
  const startTarget = controls.target.clone();
  const startTime = performance.now();

  function animate(time) {
    const t = Math.min((time - startTime) / duration, 1);
    const ease = 1 - Math.pow(1 - t, 3);

    camera.position.lerpVectors(startPos, targetPos, ease);
    controls.target.lerpVectors(startTarget, targetLookAt, ease);
    controls.update();

    if (t < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

// =============================================================================
// INSPECTOR ACTIONS
// =============================================================================

$('btnFocus').onclick = () => {
  if (selectedComponent) {
    focusOnPosition(selectedComponent.position);
  } else if (currentModel) {
    currentModel.updateMatrixWorld(true);
    const box = new THREE.Box3().setFromObject(currentModel);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    animateCamera(
      new THREE.Vector3(center.x + maxDim, center.y + maxDim * 0.6, center.z + maxDim),
      center,
      500
    );
  }
};

$('btnIsolate').onclick = () => {
  // TODO: implement mesh isolation
};

$('btnReset').onclick = () => {
  selectedComponent = null;

  if (currentModel && currentModelInfo) {
    currentModel.updateMatrixWorld(true);
    const box = new THREE.Box3().setFromObject(currentModel);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const maxDim = Math.max(size.x, size.y, size.z);

    animateCamera(
      new THREE.Vector3(center.x + maxDim, center.y + maxDim * 0.6, center.z + maxDim),
      center,
      500
    );

    createHotspots();
    buildExplorer();
    showModelInspector(currentModelInfo, size);
  }
};

// =============================================================================
// CONTROLS
// =============================================================================

// Wireframe toggle
$('btnWireframe').onclick = () => {
  isWireframe = !isWireframe;
  $('btnWireframe').classList.toggle('active', isWireframe);

  if (currentModel) {
    currentModel.traverse(child => {
      if (child.isMesh && child.material) {
        const mats = Array.isArray(child.material) ? child.material : [child.material];
        mats.forEach(m => { m.wireframe = isWireframe; });
      }
    });
  }
};

// Labels toggle
$('btnLabels').onclick = toggleLabels;

// Explorer close button (hides labels)
$('explorerClose').onclick = () => {
  if (labelsVisible) toggleLabels();
};

// Scale references
function buildScaleMenu() {
  let html = '';
scaleReferences.forEach(ref => {
    const state = scaleRefState[ref.id];
    html += `
      <div class="scale-menu-item" data-id="${ref.id}">
        <div class="scale-checkbox ${state.visible ? 'checked' : ''}"></div>
        <i class="ph ph-${ref.icon}"></i>
        <div class="scale-menu-item-info">
          <div class="scale-menu-item-name">${ref.name}</div>
          <div class="scale-menu-item-desc">${ref.desc}</div>
        </div>
      </div>`;
  });
  $('scaleMenuItems').innerHTML = html;

  $('scaleMenuItems').querySelectorAll('.scale-menu-item').forEach(item => {
    item.onclick = (e) => {
      e.stopPropagation();
      toggleScaleRef(item.dataset.id);
    };
  });
}

function toggleScaleRef(id) {
  const ref = scaleReferences.find(r => r.id === id);
  const state = scaleRefState[id];
  state.visible = !state.visible;

  // Update checkbox
  const item = $('scaleMenuItems').querySelector(`[data-id="${id}"]`);
  item.querySelector('.scale-checkbox').classList.toggle('checked', state.visible);

  if (state.visible && !state.mesh) {
    loaders.gltf.load(ref.path, (gltf) => {
      state.mesh = gltf.scene;
      if (ref.scale !== 1) state.mesh.scale.setScalar(ref.scale);
      if (ref.rotateY) state.mesh.rotation.y = ref.rotateY;
      scene.add(state.mesh);
      repositionScaleRefs();
      updateAttributions();
    });
  } else if (state.mesh) {
    state.mesh.visible = state.visible;
    repositionScaleRefs();
  updateAttributions();
}

  // Update button
  const activeCount = Object.values(scaleRefState).filter(s => s.visible).length;
  $('btnScale').classList.toggle('active', activeCount > 0);
}

function repositionScaleRefs() {
  if (!currentModel) return;

  currentModel.updateMatrixWorld(true);
  const modelBox = new THREE.Box3().setFromObject(currentModel);

  let index = 0;
  scaleReferences.forEach(ref => {
    const state = scaleRefState[ref.id];
    if (state.mesh && state.visible) {
      state.mesh.position.set(0, 0, 0);
      state.mesh.updateMatrixWorld(true);
      const refBox = new THREE.Box3().setFromObject(state.mesh);
      const refSize = refBox.getSize(new THREE.Vector3());

      state.mesh.position.x = modelBox.max.x + 150 + refSize.x / 2 + (index * 400);
      state.mesh.position.z = (modelBox.min.z + modelBox.max.z) / 2;

      state.mesh.updateMatrixWorld(true);
      const newBox = new THREE.Box3().setFromObject(state.mesh);
      state.mesh.position.y -= newBox.min.y;

      index++;
    }
  });
}

function updateAttributions() {
  const attrs = [];
  scaleReferences.forEach(ref => {
    const state = scaleRefState[ref.id];
    if (state.visible && ref.attribution) {
      attrs.push(ref.attribution);
    }
  });

  if (attrs.length === 0) {
    $('attributions').innerHTML = '';
    return;
  }

  $('attributions').innerHTML = attrs.map(a =>
    `<a href="${a.url}" target="_blank">"${a.title}" by ${a.author}</a><span class="license">${a.license}</span>`
  ).join('');
}

$('btnScale').onclick = (e) => {
  e.stopPropagation();
  $('scaleDropdown').classList.toggle('open');
};

$('scaleMenu').onclick = (e) => e.stopPropagation();

// =============================================================================
// CLICK DETECTION
// =============================================================================

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);

  // Check hotspots first
  const hotspotHits = raycaster.intersectObjects(hotspotGroup.children, false);
  for (const hit of hotspotHits) {
    if (hit.object.isSprite && hit.object.userData.componentId) {
      selectComponent(hit.object.userData.componentId);
        return;
      }
  }
});

// =============================================================================
// DRAG AND DROP
// =============================================================================

const dropOverlay = $('dropOverlay');

document.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropOverlay.classList.add('visible');
});

document.addEventListener('dragleave', (e) => {
  if (e.relatedTarget === null) {
    dropOverlay.classList.remove('visible');
  }
});

document.addEventListener('drop', (e) => {
  e.preventDefault();
  dropOverlay.classList.remove('visible');

  const file = e.dataTransfer.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  if (!['stl', 'glb', 'gltf'].includes(ext)) return;

  showLoading(true);

  const reader = new FileReader();
  reader.onload = (ev) => {
    if (currentModel) {
      scene.remove(currentModel);
      currentModel = null;
    }

    if (ext === 'stl') {
      const geometry = loaders.stl.parse(ev.target.result);
      geometry.computeVertexNormals();
      geometry.center();
      currentModel = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ color: 0xff6600, metalness: 0.4, roughness: 0.5 }));
    } else {
      loaders.gltf.parse(ev.target.result, '', (gltf) => {
        currentModel = gltf.scene;
        finishLoadingDroppedModel(file.name);
      });
      return;
    }

    finishLoadingDroppedModel(file.name);
  };

  reader.readAsArrayBuffer(file);
});

function finishLoadingDroppedModel(name) {
  currentModelInfo = { id: 'custom', name, desc: 'Imported file', hasLabels: false };

  currentModel.rotation.x = -Math.PI / 2;
  currentModel.updateMatrixWorld(true);
  const box = new THREE.Box3().setFromObject(currentModel);
  currentModel.position.y = -box.min.y;

  scene.add(currentModel);

  currentModel.updateMatrixWorld(true);
  const finalBox = new THREE.Box3().setFromObject(currentModel);
  const size = finalBox.getSize(new THREE.Vector3());
  const center = finalBox.getCenter(new THREE.Vector3());
  const maxDim = Math.max(size.x, size.y, size.z);

  camera.position.set(center.x + maxDim, center.y + maxDim * 0.6, center.z + maxDim);
  controls.target.copy(center);
  controls.update();

  clearHotspots();
  explorer.classList.add('hidden');
  showModelInspector(currentModelInfo, size);
  modelSelectorLabel.textContent = name;

  showLoading(false);
}

// =============================================================================
// RESIZE & ANIMATE
// =============================================================================

function resize() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
  renderer.setSize(w, h);
}

window.addEventListener('resize', resize);
resize();

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}

animate();

// =============================================================================
// INIT
// =============================================================================

buildModelSelector();
buildScaleMenu();

// Load BVR1 Production by default
const defaultModel = findModelById('bvr1');
if (defaultModel) {
  loadModel(defaultModel);
}
</script>

</body>
</html>
