server {
    listen 80;
    server_name _;

    # Inline nav script - InfluxDB uses direct port since it doesn't support subpath
    # Uses location.origin for absolute URLs and onclick handler to bypass SPA routing
    set $depot_nav_script '<script>(function(){if(document.getElementById("depot-nav"))return;var p=location.pathname,o=location.origin,h=location.hostname,c=p.startsWith("/operator/")?"operator":p.startsWith("/grafana/")?"grafana":location.port==="8086"?"influx":"portal";var n=document.createElement("div");n.id="depot-nav";n.innerHTML="<a href=\'"+o+"/\' class=\'"+(c==="portal"?"active":"")+"\'>âŒ‚</a><a href=\'"+o+"/operator/\' class=\'"+(c==="operator"?"active":"")+"\'>Operator</a><a href=\'"+o+"/grafana/\' class=\'"+(c==="grafana"?"active":"")+"\'>Dashboards</a><a href=\'"+location.protocol+"//"+h+":8086/\' class=\'"+(c==="influx"?"active":"")+"\'>Database</a>";n.querySelectorAll(\"a\").forEach(function(a){a.onclick=function(e){e.preventDefault();e.stopPropagation();window.location.href=a.href}});var s=document.createElement("style");s.textContent="#depot-nav{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:2px;background:rgba(0,0,0,0.9);border:1px solid rgba(255,255,255,0.2);padding:4px;font-family:Berkeley Mono,SF Mono,monospace;font-size:11px;z-index:2147483647;backdrop-filter:blur(8px)}#depot-nav a{color:rgba(255,255,255,0.7);text-decoration:none;padding:4px 10px;transition:all 0.15s;cursor:pointer}#depot-nav a:hover{background:#ff6600;color:#000}#depot-nav a.active{background:rgba(255,255,255,0.15);color:#fff}";document.head.appendChild(s);document.body.appendChild(n)})();</script>';

    # Portal landing page
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Operator app
    location /operator/ {
        proxy_pass http://operator:80/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for teleop
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;

        # Inject navigation bar
        proxy_set_header Accept-Encoding "";
        sub_filter '</body>' '$depot_nav_script</body>';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Grafana dashboards (don't strip prefix - Grafana handles /grafana/ subpath)
    location /grafana/ {
        proxy_pass http://grafana:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support for live updates
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Inject navigation bar
        proxy_set_header Accept-Encoding "";
        sub_filter '</body>' '$depot_nav_script</body>';
        sub_filter_once on;
        sub_filter_types text/html;
    }

    # Discovery API (for fleet status)
    location /api/discovery/ {
        proxy_pass http://discovery:4860/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Map API
    location /api/maps/ {
        proxy_pass http://map-api:4870/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
