<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Muni Depot</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="header">
  <strong>MUNI DEPOT</strong>
  <span>Fleet Operations Center</span>
</div>

<div class="services">
  <a href="/operator/" class="service-card">
    <div class="service-header">
      <span class="service-name">Operator</span>
      <span class="status-dot" id="status-operator"></span>
    </div>
    <div class="service-desc">Teleop interface, fleet overview, maps</div>
  </a>

  <a href="/grafana/" class="service-card">
    <div class="service-header">
      <span class="service-name">Dashboards</span>
      <span class="status-dot" id="status-grafana"></span>
    </div>
    <div class="service-desc">Grafana metrics and fleet analytics</div>
  </a>

  <a id="influx-link" class="service-card">
    <div class="service-header">
      <span class="service-name">Database</span>
      <span class="status-dot" id="status-influx"></span>
    </div>
    <div class="service-desc">InfluxDB metrics administration</div>
  </a>
</div>

<div class="fleet-summary" id="fleet-summary">
  <div class="section-title">Fleet Status</div>
  <pre id="fleet-status">Connecting...</pre>
</div>

<div class="footer">
  <span class="muted">Direct access:</span>
  <a id="direct-operator">:8080</a>
  <a id="direct-grafana">:3000</a>
  <a id="direct-influx">:8086</a>
</div>

<script>
const host = location.hostname;
const influxUrl = '//' + host + ':8086/';

// Set dynamic URLs
document.getElementById('influx-link').href = influxUrl;
document.getElementById('direct-operator').href = '//' + host + ':8080/';
document.getElementById('direct-grafana').href = '//' + host + ':3000/';
document.getElementById('direct-influx').href = influxUrl;

async function checkHealth(id, url) {
  const dot = document.getElementById('status-' + id);
  try {
    const res = await fetch(url, { method: 'GET', mode: 'no-cors' });
    dot.classList.add('online');
    dot.title = 'Online';
  } catch (e) {
    dot.classList.add('offline');
    dot.title = 'Offline';
  }
}

async function fetchFleetStatus() {
  const el = document.getElementById('fleet-status');
  try {
    const res = await fetch('/api/discovery/rovers');
    if (!res.ok) throw new Error('Discovery unavailable');
    const rovers = await res.json();
    if (rovers.length === 0) {
      el.textContent = 'No rovers registered';
      return;
    }
    const lines = rovers.map(r => {
      const status = r.online ? '■' : '○';
      const statusClass = r.online ? 'online' : 'offline';
      return `<span class="${statusClass}">${status}</span> ${r.id.padEnd(12)} ${r.name || ''}`;
    });
    el.innerHTML = lines.join('\n');
  } catch (e) {
    el.textContent = 'Discovery service unavailable';
  }
}

// Check service health
checkHealth('operator', '/operator/');
checkHealth('grafana', '/grafana/api/health');
checkHealth('influx', influxUrl + 'health');

// Fetch fleet status
fetchFleetStatus();

// Refresh every 30s
setInterval(() => {
  checkHealth('operator', '/operator/');
  checkHealth('grafana', '/grafana/api/health');
  checkHealth('influx', influxUrl + 'health');
  fetchFleetStatus();
}, 30000);
</script>

</body>
</html>
