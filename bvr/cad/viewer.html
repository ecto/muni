<!DOCTYPE html>
<html>
<head>
    <title>BVR CAD Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 250px; padding: 20px; background: #16213e; border-right: 1px solid #333; }
        .sidebar h2 { margin-bottom: 20px; font-size: 18px; }
        .file-list { list-style: none; }
        .file-list li {
            padding: 10px; margin: 5px 0; background: #1a1a2e;
            border-radius: 6px; cursor: pointer; transition: background 0.2s;
        }
        .file-list li:hover { background: #0f3460; }
        .file-list li.active { background: #e94560; }
        .viewer { flex: 1; position: relative; }
        #info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 6px; }
        #reload { position: absolute; top: 10px; right: 10px; padding: 10px 20px; background: #e94560; border: none; color: white; border-radius: 6px; cursor: pointer; }
        #reload:hover { background: #ff6b6b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>BVR1 Parts</h2>
            <ul class="file-list" id="fileList"></ul>
            <p style="margin-top: 20px; font-size: 12px; color: #888;">
                Click a part to view.<br>
                Drag to rotate, scroll to zoom.
            </p>
        </div>
        <div class="viewer">
            <div id="info">Select a part</div>
            <button id="reload" onclick="location.reload()">Reload</button>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';

        const files = [
            { name: 'Motor Mount (L-bracket)', path: 'exports/motor_mount_8in.stl' },
            { name: 'Motor Mount Plate', path: 'exports/motor_mount_plate_8in.stl' },
            { name: 'Motor Mount Tab', path: 'exports/motor_mount_tab_8in.stl' },
            { name: 'Wheel Spacer (round)', path: 'exports/wheel_spacer_8in.stl' },
            { name: 'Wheel Spacer (flat)', path: 'exports/wheel_spacer_flat_8in.stl' },
            { name: 'Electronics Plate', path: 'exports/electronics_plate.stl' },
            { name: 'Electronics Plate (simple)', path: 'exports/electronics_plate_simple.stl' },
            { name: 'Sensor Mount', path: 'exports/sensor_mount.stl' },
            { name: 'Sensor Mount Base', path: 'exports/sensor_mount_base.stl' },
        ];

        // Setup
        const canvas = document.getElementById('canvas');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth - 250, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 250) / window.innerHeight, 0.1, 2000);
        camera.position.set(150, 150, 150);

        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(100, 100, 100);
        scene.add(dirLight);
        const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight2.position.set(-100, -100, -100);
        scene.add(dirLight2);

        // Grid
        const grid = new THREE.GridHelper(200, 20, 0x444444, 0x333333);
        grid.rotation.x = Math.PI / 2;
        scene.add(grid);

        // Axes
        scene.add(new THREE.AxesHelper(50));

        let currentMesh = null;
        const loader = new STLLoader();
        const material = new THREE.MeshStandardMaterial({
            color: 0x4a9eff,
            metalness: 0.3,
            roughness: 0.6
        });

        function loadSTL(path, name) {
            if (currentMesh) scene.remove(currentMesh);

            document.getElementById('info').textContent = 'Loading...';

            loader.load(
                path + '?t=' + Date.now(), // Cache bust
                (geometry) => {
                    geometry.computeVertexNormals();
                    geometry.center();

                    currentMesh = new THREE.Mesh(geometry, material);
                    scene.add(currentMesh);

                    // Fit camera
                    const box = new THREE.Box3().setFromObject(currentMesh);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    camera.position.set(maxDim * 1.5, maxDim * 1.5, maxDim * 1.5);
                    controls.target.set(0, 0, 0);
                    controls.update();

                    document.getElementById('info').textContent =
                        `${name}\n${size.x.toFixed(1)} x ${size.y.toFixed(1)} x ${size.z.toFixed(1)} mm`;
                },
                undefined,
                (err) => {
                    document.getElementById('info').textContent = 'Error loading: ' + err.message;
                }
            );
        }

        // Build file list
        const fileList = document.getElementById('fileList');
        files.forEach((file, i) => {
            const li = document.createElement('li');
            li.textContent = file.name;
            li.onclick = () => {
                document.querySelectorAll('.file-list li').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                loadSTL(file.path, file.name);
            };
            fileList.appendChild(li);
        });

        // Load first file
        fileList.children[0].click();

        // Animate
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 250) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 250, window.innerHeight);
        });
    </script>
</body>
</html>
